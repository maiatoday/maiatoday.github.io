<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Hammer and nail There is no doubt LiveData is an easy, lifecycle safe way to observe some state which needs to be displayed on the UI. It is just so easy to create and easy to update. It is easy to observe. I think that may be why people use it everywhere where they need a simple observation. This ok, no guilt, no harm &amp;hellip;. for the UI layers &amp;hellip;. but there are better solutions for domain and data layers."><title>I still see LiveData - where are the Flows?</title><link rel=canonical href=https://www.maiatoday.net/p/i-still-see-livedata-where-are-the-flows/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="I still see LiveData - where are the Flows?"><meta property="og:description" content="Hammer and nail There is no doubt LiveData is an easy, lifecycle safe way to observe some state which needs to be displayed on the UI. It is just so easy to create and easy to update. It is easy to observe. I think that may be why people use it everywhere where they need a simple observation. This ok, no guilt, no harm &amp;hellip;. for the UI layers &amp;hellip;. but there are better solutions for domain and data layers."><meta property="og:url" content="https://www.maiatoday.net/p/i-still-see-livedata-where-are-the-flows/"><meta property="og:site_name" content="maiatoday"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="code"><meta property="article:tag" content="refactor"><meta property="article:tag" content="live data"><meta property="article:tag" content="flow"><meta property="article:published_time" content="2023-07-30T21:38:36+02:00"><meta property="article:modified_time" content="2023-07-30T21:38:36+02:00"><meta property="og:image" content="https://www.maiatoday.net/p/i-still-see-livedata-where-are-the-flows/hammer.png"><meta name=twitter:site content="@maiatoday"><meta name=twitter:creator content="@maiatoday"><meta name=twitter:title content="I still see LiveData - where are the Flows?"><meta name=twitter:description content="Hammer and nail There is no doubt LiveData is an easy, lifecycle safe way to observe some state which needs to be displayed on the UI. It is just so easy to create and easy to update. It is easy to observe. I think that may be why people use it everywhere where they need a simple observation. This ok, no guilt, no harm &amp;hellip;. for the UI layers &amp;hellip;. but there are better solutions for domain and data layers."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.maiatoday.net/p/i-still-see-livedata-where-are-the-flows/hammer.png"><link rel="shortcut icon" href=favicon/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-1K04GCNEKX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1K04GCNEKX",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/MaiaGDE-Badge2022_hu5b1f8088ae53ff6906d7c10dccfceb5c_7732931_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üê∂</span></figure><div class=site-meta><h1 class=site-name><a href=/>maiatoday</a></h1><h2 class=site-description>Android dev ‚ù§Ô∏èKotlin üê∂</h2></div></header><ol class=social-menu><li><a href=https://github.com/maiatoday target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://androiddev.social/@maiatoday target=_blank title=Mastodon rel=me><svg xmlns="http://www.w3.org/2000/svg" width="61.076954mm" height="65.47831mm" viewBox="0 0 216.4144 232.00976"><path fill="#2b90d9" d="M211.80734 139.0875c-3.18125 16.36625-28.4925 34.2775-57.5625 37.74875-15.15875 1.80875-30.08375 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125.0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.39125 27.9425 21.11625.7225 39.91875-5.20625 39.91875-5.20625l.8675 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23234 213.82 1.40609 165.31125.20859 116.09125c-.365-14.61375-.14-28.39375-.14-39.91875.0-50.33 32.97625-65.0825 32.97625-65.0825C49.67234 3.45375 78.20359.2425 107.86484.0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09.0.0 32.975 14.7525 32.975 65.0825.0.0.41375 37.13375-4.59875 62.915"/><path fill="#fff" d="M177.50984 80.077v60.94125h-24.14375v-59.15c0-12.46875-5.24625-18.7975-15.74-18.7975-11.6025.0-17.4175 7.5075-17.4175 22.3525v32.37625H96.20734V85.42325c0-14.845-5.81625-22.3525-17.41875-22.3525-10.49375.0-15.74 6.32875-15.74 18.7975v59.15H38.90484V80.077c0-12.455 3.17125-22.3525 9.54125-29.675 6.56875-7.3225 15.17125-11.07625 25.85-11.07625 12.355.0 21.71125 4.74875 27.8975 14.2475l6.01375 10.08125 6.015-10.08125c6.185-9.49875 15.54125-14.2475 27.8975-14.2475 10.6775.0 19.28 3.75375 25.85 11.07625 6.36875 7.3225 9.54 17.22 9.54 29.675"/></svg></a></li><li><a href=https://twitter.com/maiatoday target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#hammer-and-nail>Hammer and nail</a></li><li><a href=#but-why-not>But why not</a></li><li><a href=#conversion>Conversion</a></li><li><a href=#putting-a-value-into-the-stateflow>Putting a value into the StateFlow</a></li><li><a href=#collecting-flows>Collecting flows</a><ul><li><a href=#in-a-view-model>In a view model</a></li><li><a href=#combining-flows>Combining flows</a></li><li><a href=#ui---compose>UI - Compose</a></li><li><a href=#ui---xml>UI - XML</a></li></ul></li><li><a href=#testing>Testing</a><ul><li><a href=#my-test-doesnt-pass>My test doesn&rsquo;t pass</a></li><li><a href=#my-test-wont-stop-running>My test won&rsquo;t stop running</a></li><li><a href=#show-me-the-code>Show me the code</a></li></ul></li><li><a href=#put-down-the-hammer-and-try-another-tool>Put down the hammer and try another tool</a></li><li><a href=#more-info>More info</a><ul><li><a href=#official-documentation>Official documentation</a></li><li><a href=#videos>Videos</a></li></ul></li></ul></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/i-still-see-livedata-where-are-the-flows/><img src=/p/i-still-see-livedata-where-are-the-flows/hammer_hu33952ef3f2806e0aaa608c8ebe3efdb6_1138976_800x0_resize_box_3.png srcset="/p/i-still-see-livedata-where-are-the-flows/hammer_hu33952ef3f2806e0aaa608c8ebe3efdb6_1138976_800x0_resize_box_3.png 800w, /p/i-still-see-livedata-where-are-the-flows/hammer_hu33952ef3f2806e0aaa608c8ebe3efdb6_1138976_1600x0_resize_box_3.png 1600w" width=800 height=420 loading=lazy alt="Featured image of post I still see LiveData - where are the Flows?"></a></div><div class=article-details><header class=article-category><a href=/categories/code/>code</a>
<a href=/categories/refactor/>refactor</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/i-still-see-livedata-where-are-the-flows/>I still see LiveData - where are the Flows?</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jul 30, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><h2 id=hammer-and-nail>Hammer and nail</h2><p>There is no doubt <code>LiveData</code> is an easy, lifecycle safe way to observe some state which needs to be displayed on the UI. It is just so easy to create and easy to update. It is easy to observe. I think that may be why people use it everywhere where they need a simple observation. This ok, no guilt, no harm &mldr;. for the UI layers &mldr;. but there are better solutions for domain and data layers. This is <a class=link href=https://proandroiddev.com/dont-use-livedata-in-repositories-f3bebe502ed3 target=_blank rel=noopener>not the first time this topic has come up</a> yet I still see Live Data in a repository offered as a good solution from time to time, in blog posts, samples and in books. I think it is a case of people think they <a class=link href=https://en.wiktionary.org/wiki/if_all_you_have_is_a_hammer,_everything_looks_like_a_nail target=_blank rel=noopener>only have a LiveData hammer</a>.</p><p>There are infact pitfalls if you use <code>LiveData</code> in a repository. I think it&rsquo;s an anti-pattern.</p><h2 id=but-why-not>But why not</h2><ul><li><p><code>LiveData</code> is lifecycle aware - do we need this in our repository? Repostitories are typically provided by dependency injection, they could be singletons and they <em>don&rsquo;t need to know about the Android lifecycle</em>.</p></li><li><p><code>LiveData</code> <em>always</em> runs on the main thread, you can&rsquo;t change this. This is not what we want in a repository. Repositories often work with different data sources which could involve network or disk access tasks. I would argue that you <em>need</em> to be able to run these kinds of tasks on the correct dispatcher if your libraries do not already do this. <strong>This is the deal breaker for me because you can cause jank in the UI if you do this incorrectly</strong>.</p></li><li><p><code>LiveData</code> does have some capabilities to combine and convert <code>LiveData</code> variables with <code>MediatorLiveData</code> but flows provide a wide variety of elegant operators to choose from. This is probably not a solid argument more a case of convenience.</p></li><li><p>Lastly, one of the biggest reasons after the main thread argument, why I would advocate for converting all of the <code>LiveData</code> use to flows: <em>flows are part of the Kotlin coroutines library</em>. This means they run on any platform where Kotlin coroutines run. You can use them in a multiplatform project. Or to put it differently, if you use flows in your repository instead of <code>LiveData</code> it is one less Android library that you have to remove and replace when you want to use the repository on another platform.</p></li></ul><h2 id=conversion>Conversion</h2><p>Replace <code>LiveData</code> with <code>StateFlow</code> and <code>MutableLiveData</code> with <code>MutableStateFlow</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>_error</span><span class=p>:</span> <span class=n>MutableLiveData</span><span class=p>&lt;</span><span class=n>String</span><span class=p>?&gt;</span> <span class=p>=</span> <span class=n>MutableLiveData</span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>error</span><span class=p>:</span> <span class=n>LiveData</span><span class=p>&lt;</span><span class=n>String</span><span class=p>?&gt;</span> <span class=p>=</span> <span class=n>_error</span>
</span></span></code></pre></div><p>becomes</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>_error</span><span class=p>:</span> <span class=n>MutableStateFlow</span><span class=p>&lt;</span><span class=n>String</span><span class=p>?&gt;</span> <span class=p>=</span> <span class=n>MutableStateFlow</span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>override</span> <span class=k>val</span> <span class=py>error</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>String</span><span class=p>?&gt;</span> <span class=p>=</span> <span class=n>_error</span><span class=p>.</span><span class=n>asStateFlow</span><span class=p>()</span>
</span></span></code></pre></div><p>and then fix the pieces that don&rsquo;t compile. It may be some header imports and some changes in the places where the <code>LiveData</code> was observed but the compiler will help you.</p><h2 id=putting-a-value-into-the-stateflow>Putting a value into the StateFlow</h2><p><code>StateFlow</code> always needs an initial value. So you will need to do that when you declare the <code>StateFlow</code>. Then to change the value you simply set it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>_error</span><span class=p>.</span><span class=k>value</span> <span class=p>=</span> <span class=s2>&#34;Ooops!!!&#34;</span>
</span></span></code></pre></div><h2 id=collecting-flows>Collecting flows</h2><p>To get the values out of the <code>LiveData</code> you need to collect the StateFlow. Depending over which architecture layer you are observing the data it may look slightly different.</p><h3 id=in-a-view-model>In a view model</h3><p>If you simply need to collect the flow from a repository you can do it like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>fun</span> <span class=nf>onRefresh</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>repository</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>someOrOtherFlow</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>collect</span> <span class=p>{</span> <span class=n>result</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=n>doSomething</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=combining-flows>Combining flows</h3><p>If you had a situation where you were using <code>MediatorLiveData</code>, there are many flow intermediate operators to choose from which you can use to convert and combine flows. I will show an example of where two observables were combined. In the <code>LiveData</code> world you would have achieved this by using <code>addSource()</code> on the <code>MediatorLiveData</code>. Here is the flow solution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>uiState</span> <span class=p>=</span> <span class=n>flow1</span><span class=p>.</span><span class=n>combine</span><span class=p>(</span><span class=n>flow2</span><span class=p>)</span> <span class=p>{</span> <span class=n>value1</span><span class=p>,</span> <span class=n>value2</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// this block is called if either flow1 or flow2 emits
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// it then emits a new value in a flow
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>UiState</span><span class=p>(</span><span class=n>value1</span><span class=p>,</span> <span class=n>value2</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// it is a flow so convert it to a StateFlow
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=n>stateIn</span><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=n>scope</span> <span class=p>=</span> <span class=n>viewModelScope</span><span class=p>,</span> <span class=c1>// provide a scope for the flow to be shared in
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>started</span> <span class=p>=</span> <span class=n>WhileSubscribed</span><span class=p>(</span><span class=m>5000</span><span class=p>),</span> <span class=c1>// controls when the sharing is started, in this case starts when there is a subscriber and stops 5 seconds after the last one is no longer subscribed
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>initialValue</span> <span class=p>=</span> <span class=n>UiState</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h3 id=ui---compose>UI - Compose</h3><p>Use the handy <code>collectAsStateWithLifecycle()</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>error</span> <span class=k>by</span> <span class=n>viewModel</span><span class=p>.</span><span class=n>error</span><span class=p>.</span><span class=n>collectAsStateWithLifecycle</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=ui---xml>UI - XML</h3><p>There is a good writeup on how to do that <a class=link href=https://medium.com/androiddevelopers/a-safer-way-to-collect-flows-from-android-uis-23080b1f8bda target=_blank rel=noopener>here</a> but the code snippet is this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>lifecycleScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>repeatOnLifecycle</span><span class=p>(</span><span class=nc>Lifecycle</span><span class=p>.</span><span class=nc>State</span><span class=p>.</span><span class=n>STARTED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Flow will be collected when the lifecycle is Started
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// and collection is stopped when the lifecycle is STOPPED
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>viewModel</span><span class=p>.</span><span class=n>error</span><span class=p>.</span><span class=n>collect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// use the updated error message
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=testing>Testing</h2><p>Testing <code>StateFlow</code> can sometimes feel tricky because they use coroutines to do their magic especially if you are doing something with the dispatchers in your repositories. The kotlinx coroutines test library has good support to help with the testing scenarios you may encounter. Here are some scenarios I encountered.</p><h3 id=my-test-doesnt-pass>My test doesn&rsquo;t pass</h3><p>Everything looks fine but the test fails because the value in the <code>StateFlow</code> isn&rsquo;t what you expect it to be. Writing a test that does something on a coroutine means that you might find yourself in a position where you try to check the value of the <code>StateFlow</code> before the coroutine completes. The solution to this is to call <code>advanceUntilIdle()</code> which will make sure the coroutines get a chance to complete before you assert the value of the StateFlow.</p><h3 id=my-test-wont-stop-running>My test won&rsquo;t stop running</h3><p><code>StateFlow</code> is a hot flow. Depending on how it was created, e.g. using a stateIn gives a parameter to prevent the StateFlow from being started until someone subscribes. You need to subscribe/collect the StateFlow to get any data from it. Now the hot flow is well, hot. This will stop the test from completing. My initial instinct was to get the job on which the StateFlow was collected and kill it at the end of the tests. Luckily there is an easier solution. The kotlinx coroutines test libraries provide a <code>backgroundScope</code>. If you kick off the flow collection on this scope, it will be cleared at the end of the test and the test will complete.</p><h3 id=show-me-the-code>Show me the code</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>`GIVEN a uiState WHEN the state is collected THEN it should have the right value`</span><span class=p>()</span> <span class=p>=</span> <span class=n>runTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>backgroundScope</span><span class=p>.</span><span class=n>launch</span><span class=p>(</span><span class=n>UnconfinedTestDispatcher</span><span class=p>(</span><span class=n>testScheduler</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// this will use the backgroundScope  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>viewModel</span><span class=p>.</span><span class=n>uiState</span><span class=p>.</span><span class=n>collect</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>assertEquals</span><span class=p>(</span><span class=n>viewModel</span><span class=p>.</span><span class=n>uiState</span><span class=p>.</span><span class=k>value</span><span class=p>,</span> <span class=p>&lt;</span><span class=n>something</span> <span class=n>that</span> <span class=n>looks</span> <span class=n>like</span> <span class=n>empty</span> <span class=n>goes</span> <span class=n>here</span><span class=p>&gt;)</span>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span><span class=p>.</span><span class=n>doSomethingThatWillChangeTheState</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>advanceUntilIdle</span><span class=p>()</span> <span class=c1>// this makes sure the coroutines complete
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>assertEquals</span><span class=p>(&lt;</span><span class=n>some</span> <span class=n>new</span> <span class=n>state</span> <span class=n>goes</span> <span class=n>here</span><span class=p>&gt;,</span> <span class=n>viewModel</span><span class=p>.</span><span class=n>uiState</span><span class=p>.</span><span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// because of backgroundScope use the job of the hot StateFlow will be cancelled and the test can complete
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Or you can use the test library <a class=link href=https://github.com/cashapp/turbine target=_blank rel=noopener>Turbine</a></p><h2 id=put-down-the-hammer-and-try-another-tool>Put down the hammer and try another tool</h2><p>At the <a class=link href="https://youtu.be/B8ppnjGPAGE?t=626" target=_blank rel=noopener>2019 Android Dev Summit</a> Jose Alc√©rreca said ‚ÄúLiveData was never designed as a fully fledged reactive streams builder‚Äù. Since <code>StateFlow</code> is almost a drop in replacement, there is really nothing to stop people from migrating or just not using LiveData in Repositories.</p><p>The Android <a class=link href=https://developer.android.com/topic/libraries/architecture/livedata#livedata-in-architecture target=_blank rel=noopener>documentation also says</a> don&rsquo;t put LiveData in the repositories.</p><p>Ah but you say you use databinding&mldr; My condolences&mldr; but it&rsquo;s ok, databinding <a class=link href=https://developer.android.com/topic/libraries/data-binding/observability#stateflow target=_blank rel=noopener>supports StateFlow</a>.</p><p>Your project is in Java&mldr; sob&mldr; my condolences. Use <code>LiveData</code> or <code>RxJava</code> or convert to Kotlin.</p><h2 id=more-info>More info</h2><p><a class=link href=https://www.maiatoday.net/p/flow-notes/ target=_blank rel=noopener>Sketch note overview of how flows work</a></p><p><a class=link href=https://academy.droidcon.com/course/migrating-livedata-to-kotlin-flow-with-tests-in-android target=_blank rel=noopener>droidcon academy course on how to do the migration with a sample project</a></p><h3 id=official-documentation>Official documentation</h3><p><a class=link href=https://developer.android.com/kotlin/flow/stateflow-and-sharedflow target=_blank rel=noopener>StateFlow and SharedFlow</a></p><p><a class=link href=https://developer.android.com/kotlin/flow/test target=_blank rel=noopener>Testing flows</a></p><p><a class=link href=https://medium.com/androiddevelopers/migrating-from-livedata-to-kotlins-flow-379292f419fb target=_blank rel=noopener>Detailed writeup of more migration techniques</a></p><h3 id=videos>Videos</h3><p><a class=link href=https://youtu.be/6hNXFs1fYaY target=_blank rel=noopener>Collecting flows in a lifecycle aware manner</a></p><p><a class=link href="https://www.youtube.com/watch?v=nKCsIHWircA" target=_blank rel=noopener>Untangling coroutine testing</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/code/>code</a>
<a href=/tags/refactor/>refactor</a>
<a href=/tags/live-data/>live data</a>
<a href=/tags/flow/>flow</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/swampy-refactor-converting-otto-bus-to-flows/><div class=article-image><img src=/p/swampy-refactor-converting-otto-bus-to-flows/swampyBus.4dc20e6befa7367dab2aa4f77b43c803_hu4b8332da4ee48ca69295aef4e280f6e7_1356365_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Swampy Refactor: Converting Otto Bus to Flows" data-hash="md5-TcIOa++nNn2rKqT3e0PIAw=="></div><div class=article-details><h2 class=article-title>Swampy Refactor: Converting Otto Bus to Flows</h2></div></a></article><article class=has-image><a href=/p/the-imitation-tortoises-song-a-fleety-conversion-from-imperative-to-functional-will-you-join-the-dance/><div class=article-image><img src=/p/the-imitation-tortoises-song-a-fleety-conversion-from-imperative-to-functional-will-you-join-the-dance/mock_and_me.5846e45c00c80f9e6e1644adb0d5274d_hu7ca7ba229a307e428e43c191352ad59d_266861_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post The Imitation Tortoise's song - a fleety conversion from imperative to functional - Will you join the dance?" data-hash="md5-WEbkXADID55uFkStsNUnTQ=="></div><div class=article-details><h2 class=article-title>The Imitation Tortoise's song - a fleety conversion from imperative to functional - Will you join the dance?</h2></div></a></article><article class=has-image><a href=/p/animated-pixie-dust-cursor-and-more/><div class=article-image><img src=/p/animated-pixie-dust-cursor-and-more/glitterBox.a3832142dae81dda25de2267cbf391ea_hud788ae5c3a515612dadfc1419662ea91_96355_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Animated Pixie Dust Cursor and more" data-hash="md5-o4MhQtroHdol3iJny/OR6g=="></div><div class=article-details><h2 class=article-title>Animated Pixie Dust Cursor and more</h2></div></a></article><article class=has-image><a href=/p/confetti-cleanup/><div class=article-image><img src=/p/confetti-cleanup/confetti_doge.f986c7861cf2b9155e9e6f8435f76723_hua96701f229dcdbb6d8818d2e1e5ed2c2_156508_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Confetti Cleanup" data-hash="md5-+YbHhhzyuRVenm+ENfdnIw=="></div><div class=article-details><h2 class=article-title>Confetti Cleanup</h2></div></a></article><article class=has-image><a href=/p/welcome-you-are-visitor-number-12345/><div class=article-image><img src=/p/welcome-you-are-visitor-number-12345/visitorCounter.3d2d9bd34ee276e593bfbd8bac20b717_hu9d445d78dd9da3a596374f2fa2fb4085_20893_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Welcome you are visitor number 12345" data-hash="md5-PS2b007iduWTv72LrCC3Fw=="></div><div class=article-details><h2 class=article-title>Welcome you are visitor number 12345</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2012 -
2023 maiatoday</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>