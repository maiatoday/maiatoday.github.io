<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='The story starts I was wandering around my day job&rsquo;s code base and I happened on a time capsule - a pristine Java Activity studded with semi-colons, a snapshot of how we built things in 2014. All the member variables started with m and there was plenty of logic to update the screen and dictate actions. Despite being old, it&rsquo;s still used every day by users. Why would I change it?
'><title>Swampy Refactor: Converting Otto Bus to Flows</title>
<link rel=canonical href=https://www.maiatoday.net/p/swampy-refactor-converting-otto-bus-to-flows/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property='og:title' content='Swampy Refactor: Converting Otto Bus to Flows'><meta property='og:description' content='The story starts I was wandering around my day job&rsquo;s code base and I happened on a time capsule - a pristine Java Activity studded with semi-colons, a snapshot of how we built things in 2014. All the member variables started with m and there was plenty of logic to update the screen and dictate actions. Despite being old, it&rsquo;s still used every day by users. Why would I change it?
'><meta property='og:url' content='https://www.maiatoday.net/p/swampy-refactor-converting-otto-bus-to-flows/'><meta property='og:site_name' content='maiatoday'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='code'><meta property='article:tag' content='otto bus'><meta property='article:tag' content='flow'><meta property='article:tag' content='swampy'><meta property='article:tag' content='refactor'><meta property='article:published_time' content='2023-07-17T19:18:36+02:00'><meta property='article:modified_time' content='2023-07-17T19:18:36+02:00'><meta property='og:image' content='https://www.maiatoday.net/p/swampy-refactor-converting-otto-bus-to-flows/swampyBus.png'><meta name=twitter:site content="@maiatoday"><meta name=twitter:creator content="@maiatoday"><meta name=twitter:title content="Swampy Refactor: Converting Otto Bus to Flows"><meta name=twitter:description content="The story starts I was wandering around my day job&rsquo;s code base and I happened on a time capsule - a pristine Java Activity studded with semi-colons, a snapshot of how we built things in 2014. All the member variables started with m and there was plenty of logic to update the screen and dictate actions. Despite being old, it&rsquo;s still used every day by users. Why would I change it?
"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.maiatoday.net/p/swampy-refactor-converting-otto-bus-to-flows/swampyBus.png'><link rel="shortcut icon" href=favicon/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-1K04GCNEKX"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1K04GCNEKX")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/MaiaGDE-Badge2022_hu2595940041951729151.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>üê∂</span></figure><div class=site-meta><h1 class=site-name><a href=/>maiatoday</a></h1><h2 class=site-description>Android dev ‚ù§Ô∏èKotlin üê∂</h2></div></header><ol class=social-menu><li><a href=https://github.com/maiatoday target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://androiddev.social/@maiatoday target=_blank title=Mastodon rel=me><svg width="61.076954mm" height="65.47831mm" viewBox="0 0 216.4144 232.00976"><path fill="#2b90d9" d="M211.80734 139.0875c-3.18125 16.36625-28.4925 34.2775-57.5625 37.74875-15.15875 1.80875-30.08375 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125.0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.39125 27.9425 21.11625.7225 39.91875-5.20625 39.91875-5.20625l.8675 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23234 213.82 1.40609 165.31125.20859 116.09125c-.365-14.61375-.14-28.39375-.14-39.91875.0-50.33 32.97625-65.0825 32.97625-65.0825C49.67234 3.45375 78.20359.2425 107.86484.0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09.0.0 32.975 14.7525 32.975 65.0825.0.0.41375 37.13375-4.59875 62.915"/><path fill="#fff" d="M177.50984 80.077v60.94125h-24.14375v-59.15c0-12.46875-5.24625-18.7975-15.74-18.7975-11.6025.0-17.4175 7.5075-17.4175 22.3525v32.37625H96.20734V85.42325c0-14.845-5.81625-22.3525-17.41875-22.3525-10.49375.0-15.74 6.32875-15.74 18.7975v59.15H38.90484V80.077c0-12.455 3.17125-22.3525 9.54125-29.675 6.56875-7.3225 15.17125-11.07625 25.85-11.07625 12.355.0 21.71125 4.74875 27.8975 14.2475l6.01375 10.08125 6.015-10.08125c6.185-9.49875 15.54125-14.2475 27.8975-14.2475 10.6775.0 19.28 3.75375 25.85 11.07625 6.36875 7.3225 9.54 17.22 9.54 29.675"/></svg></a></li><li><a href=https://twitter.com/maiatoday target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li></ol><div class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></div></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#the-story-starts>The story starts</a></li><li><a href=#the-bus-disappears>The Bus disappears</a></li><li><a href=#how-to-tackle-the-migration---step-by-step>How to tackle the migration - step by step</a></li><li><a href=#why-is-the-bus-in-the-app>Why is the bus in the app</a><ul><li><a href=#async-observable-state>Async observable state</a></li><li><a href=#synchronous-notification>Synchronous notification</a></li><li><a href=#i-really-really-really-need-a-bus>I really really really need a bus</a></li><li><a href=#none-of-this-will-work-for-me>None of this will work for me</a></li></ul></li><li><a href=#example-in-the-repo---easy-swap-to-stateflow>Example in the repo - Easy swap to StateFlow</a></li></ul></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/swampy-refactor-converting-otto-bus-to-flows/><img src=/p/swampy-refactor-converting-otto-bus-to-flows/swampyBus_hu8638185585351119222.png srcset="/p/swampy-refactor-converting-otto-bus-to-flows/swampyBus_hu8638185585351119222.png 800w, /p/swampy-refactor-converting-otto-bus-to-flows/swampyBus_hu9305318416654871168.png 1600w" width=800 height=267 loading=lazy alt="Featured image of post Swampy Refactor: Converting Otto Bus to Flows"></a></div><div class=article-details><header class=article-category><a href=/categories/code/>Code
</a><a href=/categories/refactor/>Refactor</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/swampy-refactor-converting-otto-bus-to-flows/>Swampy Refactor: Converting Otto Bus to Flows</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jul 17, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><h2 id=the-story-starts>The story starts</h2><p>I was wandering around my day job&rsquo;s code base and I happened on a time capsule - a pristine Java Activity studded with semi-colons, a snapshot of how we built things in 2014. All the member variables started with <code>m</code> and there was plenty of logic to update the screen and dictate actions. Despite being old, it&rsquo;s still used every day by users. Why would I change it?</p><h2 id=the-bus-disappears>The Bus disappears</h2><p>Well, it got its data from a subscription to the Otto Bus. Otto Bus was deprecated in 2016.
<img src=/p/swampy-refactor-converting-otto-bus-to-flows/deprecatedOttoBus.png width=2282 height=588 srcset="/p/swampy-refactor-converting-otto-bus-to-flows/deprecatedOttoBus_hu6733925861690609065.png 480w, /p/swampy-refactor-converting-otto-bus-to-flows/deprecatedOttoBus_hu1571754699189194542.png 1024w" loading=lazy alt="Deprecated Otto Bus" class=gallery-image data-flex-grow=388 data-flex-basis=931px>
A blog post suggested migrating to RxJava, but since our code base standard now involves coroutines, Flows, and in some cases, LiveData, I decided to remove deprecated libraries and complete the partial migrations we started some time ago.</p><p>This blog post summarizes how to migrate from Otto Bus to Flow.</p><p>I&rsquo;ve also created a <a class=link href=https://github.com/maiatoday/Pocket8Ball target=_blank rel=noopener>Git repo</a> with a simplified example that uses Otto Bus, with a conversion to Flow in the commit history. Check out the <code>otto-bus</code> tag for the working Otto Bus version and the <code>flow</code> tag for the converted Flow version. I am sparing you the Java to Kotlin conversions. This toy app lets you tap on the 8 ball for a message. It uses Otto Bus to notify the 8 Ball that a new message is needed as well as when a new message is available.</p><p><img src=/p/swampy-refactor-converting-otto-bus-to-flows/eightball.png width=300 height=633 srcset="/p/swampy-refactor-converting-otto-bus-to-flows/eightball_hu14029414473280887154.png 480w, /p/swampy-refactor-converting-otto-bus-to-flows/eightball_hu13206581448058811046.png 1024w" loading=lazy alt="Pocket 8 Ball" class=gallery-image data-flex-grow=47 data-flex-basis=113px></p><h2 id=how-to-tackle-the-migration---step-by-step>How to tackle the migration - step by step</h2><p>Here are the basic steps for this kind of migration:</p><ol><li>Pick one <strong>event</strong></li><li>Find All the <strong>producers</strong> of this event (hopefully, there is only one but don&rsquo;t count on it)</li><li>Replace with compatible <strong>functionality</strong>. We&rsquo;ll look at how to choose compatible functionality in the next section. Things will be broken.</li><li>Find all <strong>subscribers</strong> of this event by looking for <code>@Subscribe</code> annotations. Replace with a matching access mechanism. Things should work at this point.</li><li><strong>Test</strong> that everything that used this one event still works</li><li><strong>Repeat</strong> with the next event until there are no events left to migrate</li><li><strong>Remove</strong> the Otto bus and it&rsquo;s dependencies</li><li><strong>Celebrate!</strong></li></ol><p>Of course this looks deceptively simple. As simple as it is to add otto bus to a code base. It may require some architectural refactors and modifications of how the dependency injection works in your app. Also if you were using otto bus to drive navigation, a Flow is not the right solution. I suspect the swamp you find yourself in is larger, deaper and much much more tangled. To this I would say, I hold you in my thoughts and I hope you have tests.</p><h2 id=why-is-the-bus-in-the-app>Why is the bus in the app</h2><p>I do have some advice on choosing an alternative implementation. It depends on why the otto bus was introduced in the app in the first place. The thing to understand is that the event bus pattern allows multiple producers to drop events into the bus from all over the app. On the other side of the bus any number of subscribers can wait for a particular event without knowing the origin of the event. This <em>extreme loose coupling</em> is handy however it means</p><ul><li>nothing is stopping you from coding up something unmaintainable</li><li>in large projects it is difficult to follow the logic</li><li>it is difficult to write tests</li></ul><p>For each of the events in your case ask yourself these questions.</p><h3 id=async-observable-state>Async observable state</h3><p>Was the bus used to observe a state in an asynchronous way? If this is the case, you can replace the bus with an observer pattern using a StateFlow. The producer and subscriber will be more tightly coupled but you will get cognitive support from clearer architecture. You will also get some IDE support and autocomplete to help you. You will need to look at the architecture or the dependency injection to make sure the subscriber has access to the producer so it can collect the StateFlow.</p><h3 id=synchronous-notification>Synchronous notification</h3><p>Was the bus used to notify one area in the code that something happened elsewhere? If this is synchronous then a simple method call may suffice. Again you will need to look at the architecture and the dependency injection to make sure the class notifying has access to the class that provides the method. Wrapping the class that receives the notification in an interface will make testing this code easier.</p><h3 id=i-really-really-really-need-a-bus>I really really really need a bus</h3><p>If the bus was legitimately used because you have many places in the app that need to respond to an event, you can recreate the bus functionality with a singleton and a SharedFlow. Inject the Bus into all the classes that need it and provide the SharedFlow from the injected class. Then subscribers can <code>collectLatest</code> on the <code>SharedFlow</code> and filter for the events they are interested in. Provide a method to emit something on the bus. There is a <a class=link href=https://github.com/maiatoday/Pocket8Ball/blob/flow-bus/app/src/main/java/net/maiatoday/pocket8ball/di/BusModule.kt target=_blank rel=noopener>branch in the sample repo</a> with a simple implementation of this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>interface</span> <span class=nc>FlowBus</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>bus</span><span class=p>:</span> <span class=n>SharedFlow</span><span class=p>&lt;</span><span class=n>BusEvent</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>BusEvent</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>object</span> <span class=nc>BusModule</span><span class=p>:</span> <span class=n>FlowBus</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>_bus</span> <span class=p>=</span> <span class=n>MutableSharedFlow</span><span class=p>&lt;</span><span class=n>BusEvent</span><span class=p>&gt;(</span><span class=n>replay</span> <span class=p>=</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>val</span> <span class=py>bus</span><span class=p>:</span> <span class=n>SharedFlow</span><span class=p>&lt;</span><span class=n>BusEvent</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>_bus</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>post</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>BusEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_bus</span><span class=p>.</span><span class=n>emit</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The BusEvent is a sealed class.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>sealed</span> <span class=k>class</span> <span class=nc>BusEvent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>data</span> <span class=k>class</span> <span class=nc>MessageFromTheAether</span><span class=p>(</span><span class=k>val</span> <span class=py>answer</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>:</span> <span class=n>BusEvent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>object</span> <span class=nc>ShakeItUp</span> <span class=p>:</span> <span class=n>BusEvent</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=none-of-this-will-work-for-me>None of this will work for me</h3><p>You can always resort to using a <a class=link href=https://developer.android.com/guide/components/broadcasts target=_blank rel=noopener>Broadcast receiver</a> to send a message from one part of your app to another. One thing to note if you go this route is that you will only be able to use this solution in the Android app and not in shared Kotlin only modules.</p><h2 id=example-in-the-repo---easy-swap-to-stateflow>Example in the repo - Easy swap to StateFlow</h2><p>For my toy example the producer that emits data is the Magic8Ball. Instead of posting an event on the bus, make the data available in a StateFlow.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nc>BusModule</span><span class=p>.</span><span class=n>bus</span><span class=p>.</span><span class=n>post</span><span class=p>(</span><span class=n>MessageFromeTheAether</span><span class=p>(</span><span class=n>latestMessage</span><span class=p>))</span>
</span></span></code></pre></div><p>is replaced with</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>_answer</span> <span class=p>=</span> <span class=n>MutableStateFlow</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>answer</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>_answer</span><span class=p>.</span><span class=n>asStateFlow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl> <span class=c1>// and then later when a new message is needed
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>_answer</span><span class=p>.</span><span class=k>value</span> <span class=p>=</span> <span class=n>latestMessage</span>
</span></span></code></pre></div><p>In my example the subscriber of the data is the ViewModel.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Subscribe</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>revealAnswer</span><span class=p>(</span><span class=n>message</span><span class=p>:</span> <span class=n>MessageFromeTheAether</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_uiState</span><span class=p>.</span><span class=k>value</span> <span class=p>=</span> <span class=n>Reveal</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=n>answer</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>is replaced with this snippet in typically the init block of the view model</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>eightBall</span><span class=p>.</span><span class=n>answer</span><span class=p>.</span><span class=n>collect</span> <span class=p>{</span> <span class=n>answer</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>_uiState</span><span class=p>.</span><span class=k>value</span> <span class=p>=</span> <span class=n>Reveal</span><span class=p>(</span><span class=n>answer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here is the matching video showing all the code changes.</p><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/9Si5dU9mnv0 allowfullscreen title="YouTube Video"></iframe></div></section><footer class=article-footer><section class=article-tags><a href=/tags/code/>Code</a>
<a href=/tags/otto-bus/>Otto Bus</a>
<a href=/tags/flow/>Flow</a>
<a href=/tags/swampy/>Swampy</a>
<a href=/tags/refactor/>Refactor</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/i-still-see-livedata-where-are-the-flows/><div class=article-image><img src=/p/i-still-see-livedata-where-are-the-flows/hammer.cfe51cb7dc98d06cc564bcaf7092ebdc_hu5959866716035477199.png width=250 height=150 loading=lazy alt="Featured image of post I still see LiveData - where are the Flows?" data-hash="md5-z+Uct9yY0GzFZLyvcJLr3A=="></div><div class=article-details><h2 class=article-title>I still see LiveData - where are the Flows?</h2></div></a></article><article class=has-image><a href=/p/50-ways-to-run-some-kotlin-code/><div class=article-image><img src=/p/50-ways-to-run-some-kotlin-code/runKodee.671050b3460e7f2bf3aea491b88bfd02_hu9019578545374297337.png width=250 height=150 loading=lazy alt="Featured image of post 50 ways to run some Kotlin code" data-hash="md5-ZxBQs0YOfyvzrqSRuIv9Ag=="></div><div class=article-details><h2 class=article-title>50 ways to run some Kotlin code</h2></div></a></article><article class=has-image><a href=/p/how-to-build-wrapped-2023-in-compose-animation/><div class=article-image><img src=/p/how-to-build-wrapped-2023-in-compose-animation/wrappedBanner.6198da8b0d007412374d06fe489b8c62_hu11882382130795717293.png width=250 height=150 loading=lazy alt="Featured image of post How to build Wrapped 2023 in Compose Animation" data-hash="md5-YZjaiw0AdBI3TQb+SJuMYg=="></div><div class=article-details><h2 class=article-title>How to build Wrapped 2023 in Compose Animation</h2></div></a></article><article class=has-image><a href=/p/the-imitation-tortoises-song-a-fleety-conversion-from-imperative-to-functional-will-you-join-the-dance/><div class=article-image><img src=/p/the-imitation-tortoises-song-a-fleety-conversion-from-imperative-to-functional-will-you-join-the-dance/mock_and_me.5846e45c00c80f9e6e1644adb0d5274d_hu1037725248222078373.jpg width=250 height=150 loading=lazy alt="Featured image of post The Imitation Tortoise's song - a fleety conversion from imperative to functional - Will you join the dance?" data-hash="md5-WEbkXADID55uFkStsNUnTQ=="></div><div class=article-details><h2 class=article-title>The Imitation Tortoise's song - a fleety conversion from imperative to functional - Will you join the dance?</h2></div></a></article><article class=has-image><a href=/p/animated-pixie-dust-cursor-and-more/><div class=article-image><img src=/p/animated-pixie-dust-cursor-and-more/glitterBox.a3832142dae81dda25de2267cbf391ea_hu8799213901333452394.png width=250 height=150 loading=lazy alt="Featured image of post Animated Pixie Dust Cursor and more" data-hash="md5-o4MhQtroHdol3iJny/OR6g=="></div><div class=article-details><h2 class=article-title>Animated Pixie Dust Cursor and more</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2012 -
2024 maiatoday</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.23.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>